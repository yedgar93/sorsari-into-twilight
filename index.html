<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>SORSARI - Breaking The Surface</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Tiny5&display=block"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="dist/style.css" />

    <!-- Dependencies -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r77/three.min.js"
      integrity="sha384-J0sOZ996O+UCdfXrcX0cVSVjfRvKnoXAw1rsXlFmKkOpfhmXxgtjnN1t9QDbRGR1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"
      integrity="sha384-Fe7o4IB+X/R42l4ubeFS03yRfSAAB99jbFAEQS6OSH1Sx+vKlefJt3gHPd/H6CO3"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/delaunay.js"
      integrity="sha384-lVoETraJW2XRgTPrrzIA4cJSvcHNmFtY3elWpDgV3Pf4gu80P3ELIcY6wwozqaQw"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/three_post.js"
      integrity="sha384-TmJMzD78LYNb4THRj2exJ8mquT8/KVK4KwnQ927vYYXEiflwIZKoAyVEnGuQgEo8"
      crossorigin="anonymous"
    ></script>
    <script
      type="module"
      src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"
      integrity="sha384-ycxtgj7aPUpK6OvsYarejYrITzqdS2Q6xoKkgnKMFoCyS5lQhW2h0OPCeInjM6qi"
      crossorigin="anonymous"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"
      integrity="sha384-0k1dj5tm+KUH/4vkNk/i90XsjDA8Ltmt+ybcrFoH4t0dgv/WZsPpVBnkhcroX8UL"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <!-- Debug Window (hidden by default) -->
    <div id="debug-window" class="hidden">
      <button
        id="debug-toggle-btn"
        class="debug-toggle-arrow"
        aria-label="Toggle debug window"
      >
        ◀
      </button>
      <div id="debug-header">
        Debug Controls
        <button id="debug-close-btn" aria-label="Close debug window">×</button>
      </div>
      <div id="debug-content">
        <button class="debug-btn" data-skip-time="29">
          Skip to First Drop (0:31)
        </button>
        <button class="debug-btn" data-skip-time="93">
          Skip to Breakdown (1:35)
        </button>
        <button class="debug-btn" data-skip-time="125">
          Skip to Second Drop (2:07)
        </button>
        <button class="debug-btn" data-skip-time="158">
          Skip to Invert Back (2:40)
        </button>
        <button class="debug-btn" data-skip-time="190">
          Skip to Final Fade Out (3:10)
        </button>
        <button class="debug-btn" data-skip-time="235">
          Skip to Final State (3:55)
        </button>
        <div class="debug-slider-section">
          <label for="hue-slider" class="debug-slider-label">
            Hue Rotate: <span id="hue-value">0</span>°
          </label>
          <input
            type="range"
            id="hue-slider"
            min="0"
            max="360"
            value="0"
            class="debug-slider-input"
          />
        </div>
        <div class="debug-slider-section">
          <label class="debug-slider-label">Canvas Layers:</label>
          <div style="display: flex; gap: 5px; flex-wrap: wrap">
            <button
              id="toggle-stars-canvas"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Stars ✓
            </button>
            <button
              id="toggle-three-container"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Triangles ✓
            </button>
            <button
              id="toggle-models"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Models ✓
            </button>
            <button
              id="toggle-visualizer"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Visualizer ✓
            </button>
          </div>
        </div>
        <div class="debug-slider-section">
          <label class="debug-slider-label">Triangle Effects:</label>
          <div style="display: flex; gap: 5px; flex-wrap: wrap">
            <button
              id="toggle-bloom"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Bloom ✓
            </button>
          </div>
        </div>
        <div class="debug-slider-section">
          <label class="debug-slider-label">Performance:</label>
          <div style="display: flex; gap: 5px; flex-wrap: wrap">
            <button
              id="trigger-failsafe-btn"
              class="debug-btn"
              style="
                flex: 1;
                min-width: 120px;
                background-color: #ff6b6b;
                color: white;
              "
            >
              Trigger Failsafe
            </button>
          </div>
        </div>
        <div class="debug-slider-section">
          <label for="radial-blur-slider" class="debug-slider-label">
            Radial Blur: <span id="radial-blur-value">0.5</span>
          </label>
          <input
            type="range"
            id="radial-blur-slider"
            min="0"
            max="1"
            step="0.1"
            value="0.5"
            class="debug-slider-input"
          />
        </div>
        <div id="time-display">Time: 0:00</div>
        <div id="fps-display">FPS: 60 | Frame: 0.0ms</div>
        <div id="debug-log">Debug log...</div>
        <div class="debug-slider-section">
          <label class="debug-slider-label">Device:</label>
          <div id="device-temp-display">
            Temperature: N/A (not exposed to web)
          </div>
          <div id="memory-display">Memory: --</div>
          <div id="longtask-display">Long tasks/sec: --</div>
        </div>
      </div>
    </div>

    <!-- UI Glow Layer - white glow above CRT grid to let UI luminosity shine through -->
    <div id="ui-glow-layer"></div>

    <!-- Loading spinner (appears while assets load) -->
    <div id="loading-spinner-container">
      <div id="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-text">LOADING</div>
      </div>
    </div>

    <!-- Coded by credit at bottom -->
    <div id="coded-by-credit">Coded by YEDGAR</div>

    <!-- Touch to start text (appears after loading completes) -->
    <div id="touch-to-start-container">
      <div id="touch-to-start-line1">TOUCH TO START</div>
      <div id="touch-to-start-line2">
        <span>SOUND ON</span>
        <div id="volume-icon">
          <!-- Speaker only (no arcs) -->
          <svg
            class="volume-svg volume-speaker"
            viewBox="0 0 24 24"
            fill="none"
            stroke="white"
            stroke-width="2"
          >
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          </svg>
          <!-- Speaker with one arc -->
          <svg
            class="volume-svg volume-one-arc"
            viewBox="0 0 24 24"
            fill="none"
            stroke="white"
            stroke-width="2"
          >
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M15 8a4 4 0 0 1 0 8"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Replay Button (appears 3 seconds after song ends) -->
    <button id="replay-button" aria-label="Replay song">
      <svg
        fill="#ffffff"
        viewBox="0 0 32 32"
        id="icon"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g
          id="SVGRepo_tracerCarrier"
          stroke-linecap="round"
          stroke-linejoin="round"
        ></g>
        <g id="SVGRepo_iconCarrier">
          <defs>
            <style>
              .cls-1 {
                fill: none;
              }
            </style>
          </defs>
          <title>Replay</title>
          <path
            d="M27,28a.9975.9975,0,0,1-.501-.1348l-19-11a1,1,0,0,1,0-1.73l19-11A1,1,0,0,1,28,5V27a1,1,0,0,1-1,1Z"
          ></path>
          <rect x="2" y="4" width="2" height="24"></rect>
          <rect
            id="_Transparent_Rectangle_"
            data-name="&lt;Transparent Rectangle&gt;"
            class="cls-1"
            width="28"
            height="28"
          ></rect>
        </g>
      </svg>
    </button>

    <!-- Debug window controls -->
    <script src="dist/debug.js"></script>

    <!-- SNES Intro Stars -->
    <script src="dist/snes-intro.js"></script>
    <script src="dist/ascii-shader.js"></script>

    <!-- Background layers -->
    <!-- Stars fade wrapper - CSS-based fade from 3:20 to 3:46.5 as backup -->
    <div id="stars-fade-wrapper">
      <div id="stars-canvas-wrapper">
        <canvas id="stars-canvas"></canvas>
      </div>
    </div>
    <div id="three-blur-wrapper">
      <div id="three-container"></div>
    </div>

    <!-- Audio visualizer (behind model, in front of stars) -->
    <canvas id="visualizer-canvas"></canvas>

    <!-- Top image (desktop) -->
    <img
      id="bottom-image"
      src="bottom-crop-removebg-preview.png"
      alt=""
      loading="lazy"
      decoding="async"
    />

    <!-- Mobile images -->
    <img
      id="mobile-left-image"
      src="sorsari.png"
      alt=""
      loading="lazy"
      decoding="async"
    />
    <img
      id="mobile-right-image"
      src="breaking.png"
      alt=""
      loading="lazy"
      decoding="async"
    />

    <!-- Text overlay -->
    <div id="sorsari-text">
      <p class="maintext">SORSARI</p>
      <p class="subtext">Breaking The Surface</p>
    </div>

    <!-- Track title (bottom center) -->
    <div id="track-title">Into Twilight</div>

    <!-- Song progress bar -->
    <div id="song-progress-bar"></div>

    <!-- Center model viewer with pixel blur wrapper -->
    <div id="model-pixel-blur-wrapper">
      <div id="model-viewer-wrapper">
        <model-viewer
          class="center-model-viewer"
          id="model-viewer"
          src="base_basic_shaded.glb"
          camera-orbit="0deg 75deg 105%"
          min-camera-orbit="-30deg 60deg auto"
          max-camera-orbit="30deg 90deg auto"
          field-of-view="30deg"
          camera-controls
          disable-zoom
          disable-tap
          keyboard-controls="false"
          tabindex="-1"
          interaction-prompt="none"
          loading="lazy"
        ></model-viewer>
      </div>
    </div>

    <!-- Final image (fades in at 3:35) - deferred loading since not visible until 3:33 -->
    <div id="final-image-container">
      <img
        id="final-image"
        data-src="SOSARI-BTS-FINAL-V4.JPG"
        alt="Sorsari - Breaking The Surface (Album Art)"
        data-tilt
        data-tilt-max="15"
        data-tilt-speed="400"
        data-tilt-perspective="1000"
        data-tilt-scale="1.05"
        data-tilt-glare="true"
        data-tilt-max-glare="0.3"
      />
    </div>

    <!-- TERROR model viewer (bottom right corner) -->
    <model-viewer
      class="terror-model-viewer"
      id="terror-model-viewer"
      src="TERRORbase_basic_shaded.glb"
      camera-controls
      auto-rotate
      auto-rotate-delay="0"
      rotation-per-second="45deg"
      camera-orbit="0deg 75deg 150%"
      min-camera-orbit="auto auto 150%"
      max-camera-orbit="auto auto 150%"
      field-of-view="35deg"
      disable-zoom
      disable-tap
      keyboard-controls="false"
      tabindex="-1"
      interaction-prompt="none"
      loading="lazy"
    ></model-viewer>

    <!-- Model viewer animations and text fade-in -->
    <script src="dist/model-animations.js"></script>

    <!-- Parallax stars background -->
    <script src="dist/stars.js"></script>

    <!-- Main Three.js visualization -->
    <script src="dist/script.js"></script>

    <!-- Audio visualizer -->
    <script src="dist/visualizer.js"></script>

    <!-- Bar visualizer canvas -->
    <canvas id="bar-visualizer"></canvas>

    <!-- Minimal bar visualizer -->
    <script src="dist/bar-visualizer.js"></script>

    <!-- Dithering easter egg: type "dither" to toggle full-screen pixely dithering mode -->
    <script src="dist/dither-easter-egg.js"></script>

    <!-- Easter eggs: type "yedgar", "lol", or "cure" to play SFX without stopping main track -->
    <script>
      (function () {
        // Preload all SFX files at startup (no lazy loading)
        const triggers = {
          yedgar: new Audio("F9Mog.wav"),
          lol: new Audio("CDKefkaLaugh.wav"),
          cure: new Audio("cure.wav"),
        };

        // Eagerly preload all SFX files at startup
        Object.entries(triggers).forEach(([key, audio]) => {
          audio.preload = "auto";
          audio.crossOrigin = "anonymous";
          audio.loop = false;
          // Trigger load immediately
          audio.load();
          console.log("Preloading SFX:", key);
        });

        // Web Audio fallback for WAVs that the <audio> element can't play
        let sfxAudioCtx;
        async function playViaWebAudio(url) {
          try {
            if (!sfxAudioCtx) {
              const Ctx = window.AudioContext || window.webkitAudioContext;
              sfxAudioCtx = new Ctx();
            }
            // Ensure context is running
            if (sfxAudioCtx.state === "suspended") {
              await sfxAudioCtx.resume();
            }
            const resp = await fetch(url, { cache: "force-cache" });
            const arr = await resp.arrayBuffer();
            const buffer = await sfxAudioCtx.decodeAudioData(arr);
            const source = sfxAudioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(sfxAudioCtx.destination);
            source.start(0);
            console.log("SFX (WebAudio) triggered:", url);
          } catch (err) {
            console.warn("WebAudio SFX error:", url, err && err.message);
          }
        }

        let keyBuffer = "";

        // Do not interfere with the main audio; just play concurrently
        function playSfx(triggerKey, name) {
          const audio = triggers[triggerKey];
          try {
            audio.currentTime = 0;
            const p = audio.play();
            if (p && typeof p.then === "function") {
              p.catch((err) => {
                console.warn("SFX play rejected:", name, err && err.message);
                // If element can't play (e.g., unsupported codec), use WebAudio fallback
                if (
                  String(err && err.message)
                    .toLowerCase()
                    .includes("supported sources") ||
                  String(err).includes("NotSupportedError")
                ) {
                  playViaWebAudio(name.split("/").pop());
                }
              });
            }
            console.log("SFX triggered:", name);
          } catch (_) {
            console.warn("SFX error:", name);
            // Fallback
            playViaWebAudio(name.split("/").pop());
          }
        }

        // Disable easter egg listeners on mobile to save CPU
        const isMobileEasterEgg =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );

        if (!isMobileEasterEgg) {
          window.addEventListener("keydown", function (e) {
            // Ignore modifier-only keys
            if (e.key.length !== 1) return;
            keyBuffer += e.key.toLowerCase();
            // Keep buffer reasonably small
            const maxLen = Math.max(
              "yedgar".length,
              "lol".length,
              "cure".length
            );
            if (keyBuffer.length > maxLen) {
              keyBuffer = keyBuffer.slice(-maxLen);
            }
            if (keyBuffer.endsWith("yedgar")) {
              playSfx("yedgar", "yedgar/F9Mog.wav");
            } else if (keyBuffer.endsWith("lol")) {
              playSfx("lol", "lol/CDKefkaLaugh.wav");
            } else if (keyBuffer.endsWith("cure")) {
              playSfx("cure", "cure/cure.wav");
            }
          });
        }
      })();
    </script>
  </body>
</html>
