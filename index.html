<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>SORSARI - Breaking The Surface</title>
    <link rel="stylesheet" href="dist/style.css" />

    <!-- Dependencies -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r77/three.min.js"
      integrity="sha384-J0sOZ996O+UCdfXrcX0cVSVjfRvKnoXAw1rsXlFmKkOpfhmXxgtjnN1t9QDbRGR1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"
      integrity="sha384-Fe7o4IB+X/R42l4ubeFS03yRfSAAB99jbFAEQS6OSH1Sx+vKlefJt3gHPd/H6CO3"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/delaunay.js"
      integrity="sha384-lVoETraJW2XRgTPrrzIA4cJSvcHNmFtY3elWpDgV3Pf4gu80P3ELIcY6wwozqaQw"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/three_post.js"
      integrity="sha384-TmJMzD78LYNb4THRj2exJ8mquT8/KVK4KwnQ927vYYXEiflwIZKoAyVEnGuQgEo8"
      crossorigin="anonymous"
    ></script>
    <script
      type="module"
      src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"
      integrity="sha384-ycxtgj7aPUpK6OvsYarejYrITzqdS2Q6xoKkgnKMFoCyS5lQhW2h0OPCeInjM6qi"
      crossorigin="anonymous"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"
      integrity="sha384-0k1dj5tm+KUH/4vkNk/i90XsjDA8Ltmt+ybcrFoH4t0dgv/WZsPpVBnkhcroX8UL"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <!-- Debug Window (hidden by default) -->
    <div id="debug-window" class="hidden">
      <div id="debug-header">Debug Controls</div>
      <div id="debug-content">
        <button class="debug-btn" data-skip-time="29">
          Skip to First Drop (0:31)
        </button>
        <button class="debug-btn" data-skip-time="93">
          Skip to Breakdown (1:35)
        </button>
        <button class="debug-btn" data-skip-time="125">
          Skip to Second Drop (2:07)
        </button>
        <button class="debug-btn" data-skip-time="158">
          Skip to Invert Back (2:40)
        </button>
        <button class="debug-btn" data-skip-time="190">
          Skip to Final Fade Out (3:10)
        </button>
        <button class="debug-btn" data-skip-time="235">
          Skip to Final State (3:55)
        </button>
        <div class="debug-slider-section">
          <label for="hue-slider" class="debug-slider-label">
            Hue Rotate: <span id="hue-value">0</span>°
          </label>
          <input
            type="range"
            id="hue-slider"
            min="0"
            max="360"
            value="0"
            class="debug-slider-input"
          />
        </div>
        <div class="debug-slider-section">
          <label for="layer1-blur-slider" class="debug-slider-label">
            Layer 1 Blur (Far): <span id="layer1-blur-value">0.0</span>px
          </label>
          <input
            type="range"
            id="layer1-blur-slider"
            min="0"
            max="10"
            step="0.5"
            value="0.0"
            class="debug-slider-input"
          />
        </div>
        <div class="debug-slider-section">
          <label for="layer2-blur-slider" class="debug-slider-label">
            Layer 2 Blur (Mid): <span id="layer2-blur-value">3.0</span>px
          </label>
          <input
            type="range"
            id="layer2-blur-slider"
            min="0"
            max="10"
            step="0.5"
            value="3.0"
            class="debug-slider-input"
          />
        </div>
        <div class="debug-slider-section">
          <label for="layer3-blur-slider" class="debug-slider-label">
            Layer 3 Blur (Near): <span id="layer3-blur-value">0.0</span>px
          </label>
          <input
            type="range"
            id="layer3-blur-slider"
            min="0"
            max="10"
            step="0.5"
            value="0.0"
            class="debug-slider-input"
          />
        </div>
        <div class="debug-slider-section">
          <label for="triangles-blur-slider" class="debug-slider-label">
            Triangles Blur: <span id="triangles-blur-value">5.0</span>px
          </label>
          <input
            type="range"
            id="triangles-blur-slider"
            min="0"
            max="10"
            step="0.5"
            value="5.0"
            class="debug-slider-input"
          />
        </div>
        <div class="debug-slider-section">
          <label class="debug-slider-label">Canvas Layers:</label>
          <div style="display: flex; gap: 5px; flex-wrap: wrap">
            <button
              id="toggle-stars-canvas"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Stars ✓
            </button>
            <button
              id="toggle-three-container"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Triangles ✓
            </button>
            <button
              id="toggle-models"
              class="debug-btn"
              style="flex: 1; min-width: 80px"
            >
              Models ✓
            </button>
          </div>
        </div>
        <div id="time-display">Time: 0:00</div>
        <div id="debug-log">Debug log...</div>
      </div>
    </div>

    <!-- Debug window controls -->
    <script src="dist/debug.js"></script>

    <!-- Background layers -->
    <div id="stars-canvas-wrapper">
      <canvas id="stars-canvas"></canvas>
    </div>
    <div id="three-blur-wrapper">
      <div id="three-container"></div>
    </div>

    <!-- Top image (desktop) -->
    <img
      id="bottom-image"
      src="bottom-crop-removebg-preview.png"
      alt=""
      loading="lazy"
      decoding="async"
    />

    <!-- Mobile images -->
    <img
      id="mobile-left-image"
      src="sorsari.png"
      alt=""
      loading="lazy"
      decoding="async"
    />
    <img
      id="mobile-right-image"
      src="breaking.png"
      alt=""
      loading="lazy"
      decoding="async"
    />

    <!-- Text overlay -->
    <div id="sorsari-text">
      <p class="maintext">SORSARI</p>
      <p class="subtext">Breaking The Surface</p>
    </div>

    <!-- Track title (bottom center) -->
    <div id="track-title">Into Twilight</div>

    <!-- Center model viewer -->
    <div id="model-viewer-wrapper">
      <model-viewer
        class="center-model-viewer"
        id="model-viewer"
        src="base_basic_shaded.glb"
        camera-orbit="0deg 75deg 105%"
        min-camera-orbit="-30deg 60deg auto"
        max-camera-orbit="30deg 90deg auto"
        field-of-view="30deg"
        disable-tap
        interaction-prompt="none"
        loading="lazy"
      ></model-viewer>
    </div>

    <!-- Final image (fades in at 3:35) - deferred loading since not visible until 3:33 -->
    <div id="final-image-container">
      <img
        id="final-image"
        data-src="SOSARI-BTS-FINAL-V4.JPG"
        alt="Sorsari - Breaking The Surface (Album Art)"
        data-tilt
        data-tilt-max="15"
        data-tilt-speed="400"
        data-tilt-perspective="1000"
        data-tilt-scale="1.05"
        data-tilt-glare="true"
        data-tilt-max-glare="0.3"
      />
    </div>

    <!-- TERROR model viewer (bottom right corner) -->
    <model-viewer
      class="terror-model-viewer"
      id="terror-model-viewer"
      src="TERRORbase_basic_shaded.glb"
      camera-controls
      auto-rotate
      auto-rotate-delay="0"
      rotation-per-second="45deg"
      camera-orbit="0deg 75deg 150%"
      min-camera-orbit="auto auto 150%"
      max-camera-orbit="auto auto 150%"
      field-of-view="35deg"
      disable-zoom
      disable-tap
      interaction-prompt="none"
      loading="lazy"
    ></model-viewer>

    <!-- Model viewer animations and text fade-in -->
    <script src="dist/model-animations.js"></script>

    <!-- Parallax stars background -->
    <script src="dist/stars.js"></script>

    <!-- Main Three.js visualization -->
    <script src="dist/script.js"></script>

    <!-- Easter eggs: type "yedgar", "lol", or "cure" to play SFX without stopping main track -->
    <script>
      (function () {
        // Preload all SFX files at startup (no lazy loading)
        const triggers = {
          yedgar: new Audio("F9Mog.wav"),
          lol: new Audio("CDKefkaLaugh.wav"),
          cure: new Audio("cure.wav"),
        };

        // Eagerly preload all SFX files at startup
        Object.entries(triggers).forEach(([key, audio]) => {
          audio.preload = "auto";
          audio.crossOrigin = "anonymous";
          audio.loop = false;
          // Trigger load immediately
          audio.load();
          console.log("Preloading SFX:", key);
        });

        // Web Audio fallback for WAVs that the <audio> element can't play
        let sfxAudioCtx;
        async function playViaWebAudio(url) {
          try {
            if (!sfxAudioCtx) {
              const Ctx = window.AudioContext || window.webkitAudioContext;
              sfxAudioCtx = new Ctx();
            }
            // Ensure context is running
            if (sfxAudioCtx.state === "suspended") {
              await sfxAudioCtx.resume();
            }
            const resp = await fetch(url, { cache: "force-cache" });
            const arr = await resp.arrayBuffer();
            const buffer = await sfxAudioCtx.decodeAudioData(arr);
            const source = sfxAudioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(sfxAudioCtx.destination);
            source.start(0);
            console.log("SFX (WebAudio) triggered:", url);
          } catch (err) {
            console.warn("WebAudio SFX error:", url, err && err.message);
          }
        }

        let keyBuffer = "";

        // Do not interfere with the main audio; just play concurrently
        function playSfx(triggerKey, name) {
          const audio = triggers[triggerKey];
          try {
            audio.currentTime = 0;
            const p = audio.play();
            if (p && typeof p.then === "function") {
              p.catch((err) => {
                console.warn("SFX play rejected:", name, err && err.message);
                // If element can't play (e.g., unsupported codec), use WebAudio fallback
                if (
                  String(err && err.message)
                    .toLowerCase()
                    .includes("supported sources") ||
                  String(err).includes("NotSupportedError")
                ) {
                  playViaWebAudio(name.split("/").pop());
                }
              });
            }
            console.log("SFX triggered:", name);
          } catch (_) {
            console.warn("SFX error:", name);
            // Fallback
            playViaWebAudio(name.split("/").pop());
          }
        }

        window.addEventListener("keydown", function (e) {
          // Ignore modifier-only keys
          if (e.key.length !== 1) return;
          keyBuffer += e.key.toLowerCase();
          // Keep buffer reasonably small
          const maxLen = Math.max("yedgar".length, "lol".length, "cure".length);
          if (keyBuffer.length > maxLen) {
            keyBuffer = keyBuffer.slice(-maxLen);
          }
          if (keyBuffer.endsWith("yedgar")) {
            playSfx("yedgar", "yedgar/F9Mog.wav");
          } else if (keyBuffer.endsWith("lol")) {
            playSfx("lol", "lol/CDKefkaLaugh.wav");
          } else if (keyBuffer.endsWith("cure")) {
            playSfx("cure", "cure/cure.wav");
          }
        });
      })();
    </script>
  </body>
</html>
